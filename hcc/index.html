<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KPI Digital â€” HC & Compliance</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#f7f9fc; }
    .card { box-shadow: 0 6px 18px rgba(0,0,0,0.04); }
    .small-muted { font-size:0.9rem; color:#6c757d; }

    th, td { vertical-align: middle; }

    .score-cell {
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      height: 45px;
      font-weight: bold;
      font-size: 1rem;
      padding: 0;
      text-align: center;
    }

    .score-good { background:#d4edda; color:#155724; }
    .score-mid  { background:#fff3cd; color:#856404; }
    .score-bad  { background:#f8d7da; color:#721c24; }
  </style>
</head>

<body>

<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">ðŸ“Š Sistem Penilaian KPI â€” HC & Compliance</h3>
    <button id="refreshBtn" class="btn btn-sm btn-outline-secondary" onclick="loadPeriods()">Refresh</button>
  </div>

  <!-- FILTER -->
  <div class="card p-3 mb-3">
    <div class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Periode</label>
        <select id="period" class="form-select"></select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Jabatan</label>
        <select id="jabatan" class="form-select">
          <option value="">-- pilih jabatan --</option>
          <option>GM</option>
          <option>SM Rekruitment & Development</option>
          <option>SM Personalia & Remunerasi</option>
          <option>Manager Rekrutasi</option>
          <option>Manager Development</option>
          <option>Manager Personalia</option>
          <option>Manager Remunerasi</option>
          <option>Manager Compliance</option>
        </select>
      </div>

      <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="loadKPI()">Tampilkan KPI</button>
      </div>
    </div>
  </div>

  <!-- KPI AREA -->
  <div id="kpiArea"></div>

  <!-- HANYA TOMBOL LAPORAN -->
  <div class="mt-3 d-flex flex-wrap gap-2">
    <button class="btn btn-info" onclick="showReport()">Laporan Score</button>
    <div id="resultToast" class="ms-auto small-muted"></div>
  </div>

  <hr class="my-4">

  <div class="small-muted">
    Masukkan nilai realisasi (0â€“100). Skor dihitung otomatis.
  </div>

  <div id="scoreReport" class="mt-4"></div>

</div>

<script>
const WEB_APP_URL =
  'https://script.google.com/macros/s/AKfycbxsmWTVd1TSU8AKgMFypZSuqMZNJ8eD-FHEgaaJrPWMtq-G5vpAXLOlM5fGKTClaBo/exec';

let currentKPI = [];
let sheetScore = [];

// GET wrapper
async function apiGet(params){
  const url = new URL(WEB_APP_URL);
  Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
  const res = await fetch(url);
  return res.json();
}

async function loadPeriods(){
  const sel = document.getElementById('period');
  sel.innerHTML = '';

  const periods = [
    { id: "Q1-2026", name: "Q1 - Tahun 2026" },
    { id: "Q2-2026", name: "Q2 - Tahun 2026" },
    { id: "Q3-2026", name: "Q3 - Tahun 2026" },
    { id: "Q4-2026", name: "Q4 - Tahun 2026" }
  ];

  periods.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    sel.appendChild(opt);
  });
}

async function loadKPI(){
  const jab = document.getElementById('jabatan').value;
  const period = document.getElementById('period').value;

  if(!jab) return alert('Pilih jabatan');
  if(!period) return alert('Pilih periode');

  document.getElementById('kpiArea').innerHTML =
    '<div class="text-center py-4">Memuat KPI...</div>';

  try{
    const data = await apiGet({type:'getKPI', role: jab});
    currentKPI = data;
    renderKPI(data);
  }catch(e){
    console.error(e);
    alert('Gagal load KPI');
  }
}

// RENDER KPI TABLE
function renderKPI(items){
  if(!items || !items.length){
    document.getElementById('kpiArea').innerHTML =
      '<div class="alert alert-warning">Tidak ada KPI.</div>';
    return;
  }

  let html = `
  <form id="kpiForm">
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Area KPI</th>
            <th>Indikator</th>
            <th>Target</th>
            <th class="text-center">Bobot (%)</th>
            <th class="text-center">Realisasi (%)</th>
            <th class="text-center">Skor</th>
          </tr>
        </thead>
        <tbody>
  `;

  items.forEach((r,i)=>{
    html += `
      <tr>
        <td>${i+1}</td>
        <td>${escapeHtml(r.area_kpi)}</td>
        <td>${escapeHtml(r.indikator)}</td>
        <td>${escapeHtml(r.target||'')}</td>
        <td class="text-center">${Number(r.bobot)}</td>
        <td>
          <input type="number" min="0" max="100"
            class="form-control form-control-sm text-center"
            id="real_${i}"
            onchange="onRealChange(${i})">
        </td>
        <td class="score-cell" id="score_${i}">-</td>
      </tr>`;
  });

  html += `
        </tbody>
      </table>
    </div>
  </form>
  `;

  document.getElementById('kpiArea').innerHTML = html;
}

// SAAT NILAI REALISASI DIUBAH
function onRealChange(i){
  const raw = document.getElementById('real_'+i).value;
  const cell = document.getElementById('score_'+i);

  if (raw === '') {
    cell.textContent = '-';
    cell.className = 'score-cell';
    calculateScoreAuto();
    return;
  }

  let val = parseFloat(raw) || 0;

  let bobotRaw = parseFloat(currentKPI[i].bobot) || 0;
  let bobotPercent = bobotRaw <= 1 ? bobotRaw * 100 : bobotRaw;

  const contrib = (val * bobotPercent) / 100;

  cell.textContent = contrib.toFixed(1);
  cell.classList.remove('score-good','score-mid','score-bad');

  if (val >= 80) cell.classList.add('score-good');
  else if (val >= 60) cell.classList.add('score-mid');
  else cell.classList.add('score-bad');

  // Hitung total otomatis
  calculateScoreAuto();
}

// HITUNG TOTAL SKOR OTOMATIS

function calculateScoreAuto(){
  let total = 0;
  const period = document.getElementById("period").value;
  const jabatan = document.getElementById("jabatan").value;
  
  // Simpan semua detail KPI ke array
  const kpiDetails = [];

  currentKPI.forEach((k, i) => {
    const real = parseFloat(document.getElementById("real_" + i)?.value) || 0;
    
    let bobotRaw = parseFloat(k.bobot) || 0;
    let bobotPercent = bobotRaw <= 1 ? bobotRaw * 100 : bobotRaw;
    
    total += (real * bobotPercent) / 100;
    
    // Simpan detail untuk setiap KPI
    kpiDetails.push({
      period_id: period,
      kpi_id: k.id,
      realisasi: real,
      score: (real * bobotPercent) / 100
    });
  });

  const final = total.toFixed(1);

  document.getElementById("resultToast").innerHTML = 
    `<strong>Total Skor: ${final}</strong>`;

  // Update array sheetScore
  sheetScore = sheetScore.filter(s => !(s.period === period && s.jabatan === jabatan));
  sheetScore.push({ 
    period, 
    jabatan, 
    score: final,
    details: kpiDetails 
  });
}

// SIMPAN KE ARRAY
function saveScore(period, jabatan, score){
  sheetScore = sheetScore.filter(s => !(s.period === period && s.jabatan === jabatan));

  sheetScore.push({ period, jabatan, score });
}

// SHOW MODAL LAPORAN
function showReport() {
  if (sheetScore.length === 0) {
    alert("Belum ada data score");
    return;
  }

  let html = `
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-light">
          <tr>
            <th>Periode</th>
            <th>Jabatan</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody>
  `;

  sheetScore.forEach(row => {
    html += `
      <tr>
        <td>${row.period}</td>
        <td>${row.jabatan}</td>
        <td><strong>${row.score}</strong></td>
      </tr>`;
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  document.getElementById("modalScoreBody").innerHTML = html;

  let modal = new bootstrap.Modal(document.getElementById("scoreModal"));
  modal.show();
}

function escapeHtml(s){
  return (s ?? '').toString()
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
}




// CETAK PDF
function printModalPDF() {
  let printContents = document.getElementById("modalScoreBody").innerHTML;
  let w = window.open("");

  w.document.write(`
    <html>
      <head>
        <title>Score KPI</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
      </head>
      <body style="padding: 20px;">
        ${printContents}
      </body>
    </html>
  `);

  w.document.close();
  w.print();
}

window.addEventListener('load', ()=>{ loadPeriods(); });

</script>

<!-- MODAL LAPORAN SCORE -->
<div class="modal fade" id="scoreModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Laporan Score KPI</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="modalScoreBody">
        <!-- laporan score akan di-render di sini -->
      </div>

      <div class="modal-footer">
        
        <button class="btn btn-secondary" onclick="printModalPDF()">Print PDF</button>
        <button class="btn btn-outline-dark" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
